---
alwaysApply: false
description: Firestore Rules guide for shared calendar data and change history
---
# Firestore Rules Guide

Этот проект хранит общие данные календаря в `sharedData/calendarMain` и историю изменений в подпапке `history`.

Ключевая логика находится в [app.html](mdc:app.html), где используются пути:
- `sharedData/calendarMain`
- `sharedData/calendarMain/history/{docId}`## Recommended Rules (единая таблица для всех авторизованных)

```txt
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Общие данные календаря (один документ для всех)
    match /sharedData/calendarMain {
      allow read, write: if request.auth != null;
    }

    // История изменений по общей таблице
    match /sharedData/calendarMain/history/{docId} {
      allow read, write: if request.auth != null;
    }

    // Старый путь (для совместимости/миграции)
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
  }
}
```

## More Secure Variant (optional)

Если нужно запретить удаление общей таблицы:

```txt
match /sharedData/calendarMain {
  allow read: if request.auth != null;
  allow create, update: if request.auth != null;
  allow delete: if false;
}
```

## Setup Checklist

1. Firebase Console -> Firestore Database -> Rules: вставить правила выше.
2. Firebase Console -> Authentication -> Sign-in method:
   - включить `Email/Password`
   - включить `Phone` (если используется вход по телефону)
3. Firebase Console -> Authentication -> Settings -> Authorized domains:
   - добавить `dima9106547999-code.github.io`
   - добавить `localhost` для локальной разработки
4. Проверить [firebase-config.js](mdc:firebase-config.js): должны быть реальные ключи проекта.

## Quick Verification

1. Открыть сайт на двух устройствах и войти на обоих.
2. На первом устройстве изменить задачу/статус.
3. На втором устройстве должно появиться обновление (realtime sync).
4. В блоке "История изменений" должна появиться запись с автором и временем.

## Typical Issues

- `permission-denied`: правила не позволяют читать/писать `sharedData`.
- Данные не синхронизируются: пользователь не авторизован или сайт открыт со старым кешем.
- История пустая: не было успешных записей в `history` или нет прав на чтение.
